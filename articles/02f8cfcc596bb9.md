---
title: "çŸ¥ã‚‰ãªã„ã¨ãƒãƒã‚‹ Next.js ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"
emoji: "ğŸš¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "react"]
published: true
---

ã“ã®è¨˜äº‹ã§ã¯ Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§å€‹äººçš„ã«ãƒãƒã£ãŸã“ã¨ã«ã¤ã„ã¦ã€ãã®ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆã¨ã©ã†è§£æ±ºã—ãŸã‹ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚
ã“ã‚ŒãŒæ­£è§£ã¨ã„ã†ã‚ã‘ã§ã¯ãªãã€ä¸€ã¤ã®è¨­è¨ˆæ¡ˆã¨ã—ã¦è¦‹ã¦ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚

## ç’°å¢ƒ

- Next.js v15.0.3
- App Router ä½¿ç”¨

## ãã®1: Server Component ã§ throw ã—ãŸã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚’ Client Component ã® Error Boundary ã§ã¯å—ã‘å–ã‚Œãªã„

### é–“é•ã„ãƒ‘ã‚¿ãƒ¼ãƒ³

Server Component ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸæ˜¨ä»Šã® Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€å…¸å‹çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã®ã‚„ã‚Šæ–¹ã‚’ã¾ãšè¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```typescript
const UsersContainer = async () => {
  const users = await getUsers()
  return <UsersPresentation users={users} />
}
```

Server Component ã§éåŒæœŸé–¢æ•°ã§ã‚ã‚‹ getUsers ã‚’å®Ÿè¡Œã—ã¦ users ã‚’ Client Component ã§ã‚ã‚‹ UsersPresentation ã«æ¸¡ã—ã¦ã„ã¾ã™ã€‚
getUsers é–¢æ•°ã¯ã€ä¸­ã§å¤–éƒ¨ã® API ã‚’å©ã„ã¦ users ã‚’å–å¾—ã—ã¾ã™ã€‚å©ã„ãŸ API ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ãŸå ´åˆã€HttpError ã¨ã„ã†ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚’ throw ã—ã¾ã™ã€‚

```typescript
class HttpError extends Error {
  constructor(message: string, status: number) {
    super(message)
    this.status = status
  }
}

const getUsers = async () => {
  const res = await fetch('https://example.com/users')

  if (!res.ok) {
    throw new HttpError('API Request Error', res.status)
  }

  const json = await res.json()

  return json
}
```

UsersContainer ã®ä¸­ã§ã‚¨ãƒ©ãƒ¼ãŒ throw ã•ã‚ŒãŸå ´åˆã€ãã‚Œã‚’ [app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç›´ä¸‹ã® error.tsx](https://nextjs.org/docs/app/building-your-application/routing/error-handling) ã§å—ã‘ã‚‹ã“ã¨ã¨ã—ã¾ã™ã€‚
error.tsx ã¨ã„ã†å‘½åã§ app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç›´ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãã¨ page ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ Error Boundary ã§å›²ã‚“ã çŠ¶æ…‹ã«ãªã‚Šã€ãã®ä¸­ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ error.tsx ã®ä¸­èº«ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦è¡¨ç¤ºã—ã¦ãã‚Œã¾ã™ã€‚

```typescript
'use client'

type Props = {
  error: Error
}

export default function Error({ error }: Props) {
  if (error instanceof HttpError) {
    switch (error.status) {
      case 400:
        return 'Bad Request'
      
      case 401:
        return 'Unauthorized'
      
      default:
        return 'Unexpected'
    }
  }
  
  return 'Unexpected'
}
```

ã“ã‚Œã§ã€getUsers ãŒ throw ã—ãŸ HttpError ã® status ã«å¿œã˜ã¦ãƒšãƒ¼ã‚¸ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¯ãšã§ã™ã€‚
ã—ã‹ã—å®Ÿéš›ã«ã“ã®å‡¦ç†ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹ã¨ã€getUsers ãŒã©ã‚“ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ HttpError ã‚’ throw ã—ãŸã¨ã—ã¦ã‚‚ã€ç”»é¢ã«ã¯ã€ŒUnexpectedã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

### ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä½•ãŒã ã‚ãªã®ã‹

ãªãœæœŸå¾…é€šã‚Šå‹•ã‹ãªã„ã®ã‹ã¨è¨€ã†ã¨ã€Server Component ã§ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚’ throw ã—ã¦ error.tsx ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã›ã‚‹å ´åˆã€error.tsx ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã•ã‚Œã‚‹ error props ã¯æ¨™æº–ã® Error ã‚¯ãƒ©ã‚¹ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚Server ã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã‚’ Client ã§è¡¨ç¤ºã™ã‚‹ã®ã§ã€å¢ƒç•Œã‚’ã¾ãŸãã“ã¨ã«ãªã‚‹ã®ã§ãã®ã¾ã¾ä½¿ãˆãªããªã‚‹ã¨ã„ã†ã®ã¯è€ƒãˆã¦ã¿ã‚Œã°å½“ç„¶ã§ã™ã­ã€‚
ãã®ãŸã‚ã€error props ã«ã¯ HttpError ã§ã¯ãªã Error ã‚¯ãƒ©ã‚¹ãŒå…¥ã£ã¦ãã‚‹ã®ã§ if æ–‡ã®æ¡ä»¶ã«åˆã‚ãšã€Œunexpectedã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨ã„ã†ã‚ã‘ã§ã™ã€‚

ã§ã¯ error.tsx ã« 'use client' ã‚’è¨˜è¿°ã›ãš Server Component ã¨ã—ã¦æ‰±ãˆã°è‰¯ã„ã®ã§ã¯ï¼Ÿã¨ãªã‚Šãã†ã§ã™ãŒã€error.tsx ã¯ Client Component ã‚’å¼·åˆ¶ã•ã‚Œã‚‹ãŸã‚ãã‚Œã¯ã§ãã¾ã›ã‚“ã€‚

## ãã®2: production mode ã§ã¯ Server Comopnent ã§ throw ã—ãŸã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã¯ Client Comopnent ã‹ã‚‰ã¯ã‚ã‹ã‚‰ãªã„

### é–“é•ã„ãƒ‘ã‚¿ãƒ¼ãƒ³

ã¨ã„ã†ã“ã¨ã§ã€ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã¦ã‚‚æ„å‘³ãŒãªã„ã®ã§ã€ãã†ãªã‚‹ã¨æ¨™æº–ã® Error ã‚¯ãƒ©ã‚¹ã§ message ã‚’å·¥å¤«ã—ãŸããªã‚Šã¾ã™ã€‚

```typescript
const UsersContainer = async () => {
  try {
    const users = await getUsers()
    return <UsersPresentation users={users} />
  } catch (e) {
    if (error instanceof HttpError) {
      throw new Error(`${error.status}/${error.message}`)
    }

    throw new Error(error.message)
  }
}
```

```typescript
export default function Error({ error }: Props) {
  const [status, message] = error.message.split('/')

  switch (status) {
    case '400':
      return 'Bad Request'

    case '401':
      return 'Unauthorized'

    default:
      return 'Unexpected'
  }

  return 'Unexpected'
}
```

UsersContainer ã§ã‚¨ãƒ©ãƒ¼ã‚’ catch ã—ãŸã‚‰ HttpError ã® status ã‚’æ¨™æº–ã® Error ã‚¯ãƒ©ã‚¹ã® message ã«æ–‡å­—åˆ—ã¨ã—ã¦åŸ‹ã‚è¾¼ã‚“ã ä¸Šã§ throw ã—ç›´ã—ã¦ã„ã¾ã™ã€‚
ã“ã†ã™ã‚‹ã¨ã€Error ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯æƒ³å®šé€šã‚Š getUsers ã‹ã‚‰æŠ•ã’ã‚‰ã‚ŒãŸ HttpError ã® status ã«ã‚ã‚ã›ãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã§ã‚ã§ãŸã—ã‚ã§ãŸã—ã«è¦‹ãˆã¾ã™ãŒã€å®Ÿã¯ã“ã®æ›¸ãæ–¹ã§å‹•ãã®ã¯ Next.js ã® dev mode ã§å‹•ã‹ã—ãŸå ´åˆã®ã¿ã§ã€`next build && next start` ã§ production mode ã§å‹•ã‹ã—ãŸå ´åˆã¯æƒ³å®šé€šã‚Šã®æŒ™å‹•ã‚’ã—ãªããªã‚Šã¾ã™ã€‚

### ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä½•ãŒã ã‚ãªã®ã‹

production mode ã§å‹•ã‹ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ãŸéš›ã« error.tsx ã« props ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ error ã® message ã‚’è¦‹ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```
Error: An error occurred in the Server Components render. The specific message is omitted in production builds to avoid leaking sensitive details. A digest property is included on this error instance which may provide additional details about the nature of the error.
```

(è¨³: Server Components ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å…·ä½“çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€æ©Ÿå¯†æƒ…å ±ã®æ¼ãˆã„ã‚’é˜²ããŸã‚ã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰ã§ã¯çœç•¥ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚)

ã“ã‚Œã¯ production mode ã®å ´åˆã€ã‚µãƒ¼ãƒãƒ¼å´ã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãã®ã¾ã¾æ¸¡ã—ã¦ã—ã¾ã†ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç”Ÿã®ã‚¨ãƒ©ãƒ¼ãŒè¦‹ãˆã¦ã—ã¾ã†ãŸã‚ã€Next.js å´ã§ã‚¨ãƒ©ãƒ¼ã®ä¸­èº«ã‚’å¤‰æ›ã—ã¦ãã‚Œã‚‹ã‚†ãˆã«ã“ã†ãªã‚Šã¾ã™ã€‚

## è§£æ±ºç­–

ã¨ã„ã†ã“ã¨ã§æŒ™å‹•ãŒç†è§£ã§ããŸã®ã§ã€è§£æ±ºæ–¹æ³•ã¨ã—ã¦ã¯è‰²ã‚“ãªã‚„ã‚Šæ–¹ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¾ã§ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å¤§ããæ§‹é€ ã‚’å¤‰ãˆãšã«å‹•ãã‚ˆã†ã«ã™ã‚‹ã«ã¯ã©ã†ã™ã‚‹ã‹ã¨ã„ã†è¦–ç‚¹ã§ã®è§£æ±ºç­–ã‚’æ›¸ãã¾ã™ã€‚

ã¾ãš HttpError ã« serialize, deserialize ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨æ„ã—ã¾ã™ã€‚HttpError ã‚¯ãƒ©ã‚¹ã‚’ãƒ—ãƒ¬ãƒ¼ãƒ³ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ãŸã‚Šã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ HttpError ã«å¤‰æ›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

```typescript
type SerializedHttpError = {
  message: string
  status: number
}

class HttpError extends Error {
  constructor(message: string, status: number) {
    super(message)
    this.status = status
  }
  
  serialize(): SerializedHttpError {
    return {
      message: this.message,
      status: this.status,
    }
  }
  
  public deserialize(data: SerializedHttpError) {
    return new HttpError(data.message, data.status)
  }
}
```

ãã—ã¦ UsersContainer å†…ã§ã“ã®ã‚¨ãƒ©ãƒ¼ã‚’ Client Component ã§ã‚ã‚‹ ThrowHttpError ã«æ¸¡ã—ã¾ã™ã€‚

```typescript
const UsersContainer = async () => {
  try {
    const users = await getUsers()
    return <UsersPresentation users={users} />
  } catch (e) {
    if (error instanceof HttpError) {
      return <ThrowHttpError serializedError={e.serialize()} />
    }
    
    throw new Error(error.message)
  }
}
```

ThrowHttpError ã¯ Client Component ã¨ãªã£ã¦ã„ã¦ã€å—ã‘å–ã£ãŸã‚¨ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾ throw ã™ã‚‹ã ã‘ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚

```typescript
'use client'

type Props = {
  serializedError: SerializedHttpError
}

const ThrowHttpError = ({ serializedError }: Props) => {
  throw HttpError.deserialize(serializedError)
}
```

Client Component ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ç›´ã—ã¦ã„ã‚‹ã®ã§ã€Server ã¨ Client ã®å¢ƒç•Œã‚’ã¾ãŸã„ã§ã„ãªã„ç‚ºã€error.tsx ã¯ãã®ã‚¨ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript
export default function Error({ error }: Props) {
  if (error instanceof HttpError) {
    switch (error.status) {
      case 400:
        return 'Bad Request'
      
      case 401:
        return 'Unauthorized'
      
      default:
        return 'Unexpected'
    }
  }
  
  return 'Unexpected'
}
```

ä»¥ä¸Šã§ã€Server Component ã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã‚’ error.tsx ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å—ã‘å–ã£ã¦ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡ºã—åˆ†ã‘ã‚’ã™ã‚‹ã€ã¨ã„ã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## ã¾ã¨ã‚

Next.js ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ã®ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆã‚’ã¾ã¨ã‚ã‚‹ã¨ã€

- Server Component ã§ throw ã—ãŸã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã¯ Client Component ã® Error Boundary ã§ã¯æ¨™æº–ã® Error ã‚¯ãƒ©ã‚¹ã«å¤‰æ›ã•ã‚Œã‚‹
- production mode ã§ã¯ Server Comopnent ã§ throw ã—ãŸã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã¯ Client Comopnent ã‹ã‚‰ã¯ã‚ã‹ã‚‰ãªã„

ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
å†’é ­ã®ç¹°ã‚Šè¿”ã—ã«ãªã‚Šã¾ã™ãŒã€ã“ã®è¨˜äº‹ã§ç´¹ä»‹ã—ãŸã‚„ã‚Šæ–¹ã¯ã‚ãã¾ã§ã‚‚ä¸€ä¾‹ã§ã‚ã‚Šã€ä»–ã«ã‚ˆã‚Šè‰¯ã„ã‚„ã‚Šæ–¹ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã«å­˜åœ¨ã™ã‚‹ã®ã§ã€ä¸€ã¤ã®æ¡ˆã¨ã—ã¦å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚
